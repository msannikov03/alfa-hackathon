name: Deploy to Raspberry Pi

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Force IPv4 DNS and Deploy
        run: |
          echo "ğŸ” Resolving IPv4 address for ssh.businesslion.me..."
          # Get IPv4 address only (bypass IPv6)
          PI_IP=$(dig +short ssh.businesslion.me A | head -n1)

          if [ -z "$PI_IP" ]; then
            echo "âŒ Could not resolve IPv4 address"
            exit 1
          fi

          echo "âœ… Resolved to IPv4: $PI_IP"

          # Setup SSH with IPv4 only
          mkdir -p ~/.ssh
          echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          cat >> ~/.ssh/config << EOF
          Host pi-deploy
            HostName $PI_IP
            User ${{ secrets.PI_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            AddressFamily inet
          EOF

          echo "ğŸ”Œ Testing SSH connection..."
          ssh -o ConnectTimeout=10 pi-deploy "echo 'SSH connection successful!'"

          echo "ğŸš€ Starting deployment to Raspberry Pi..."
          ssh pi-deploy << 'ENDSSH'
            set -e
            echo "ğŸ“‚ Navigating to project directory..."
            cd ~/alfa-hackathon || { echo "Project directory not found!"; exit 1; }

            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ›‘ Stopping existing containers..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml down || true

            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f || true

            echo "ğŸ”¨ Building Docker images..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache

            echo "â–¶ï¸  Starting services..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

            echo "â³ Waiting for services to start..."
            sleep 15

            echo "ğŸ¥ Checking service health..."
            docker compose -f docker-compose.yml -f docker-compose.prod.yml ps

            echo "ğŸ” Testing backend health..."
            for i in {1..10}; do
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Backend is healthy!"
                break
              fi
              echo "Waiting for backend... ($i/10)"
              sleep 3
            done

            echo "ğŸ“‹ Recent backend logs:"
            docker compose logs --tail=20 backend

            echo "âœ… Deployment completed successfully!"
            echo "ğŸŒ App should be available at https://alfa.businesslion.me"
          ENDSSH

      - name: Deployment notification
        if: success()
        run: |
          echo "âœ… Successfully deployed to Raspberry Pi!"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"

      - name: Deployment failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Check the logs above for details"
          exit 1
