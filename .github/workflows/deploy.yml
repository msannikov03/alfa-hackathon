name: Deploy to Raspberry Pi

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Check secrets are loaded
        run: |
          echo "Checking if secrets are available..."
          if [ -z "${{ secrets.PI_HOST }}" ]; then
            echo "âŒ PI_HOST is empty!"
          else
            echo "âœ… PI_HOST is set (length: ${#PI_HOST})"
          fi
          if [ -z "${{ secrets.PI_USER }}" ]; then
            echo "âŒ PI_USER is empty!"
          else
            echo "âœ… PI_USER is set"
          fi
          if [ -z "${{ secrets.PI_SSH_KEY }}" ]; then
            echo "âŒ PI_SSH_KEY is empty!"
          else
            echo "âœ… PI_SSH_KEY is set"
          fi
        env:
          PI_HOST: ${{ secrets.PI_HOST }}

      - name: Debug - Test DNS resolution
        run: |
          echo "Testing DNS resolution..."
          nslookup ssh.businesslion.me || true
          dig ssh.businesslion.me || true
          host ssh.businesslion.me || true

          echo "Testing ping..."
          ping -c 2 ssh.businesslion.me || true

      - name: Debug - Test SSH connection
        run: |
          echo "Setting up SSH key..."
          mkdir -p ~/.ssh
          echo "${{ secrets.PI_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          echo "Testing SSH connection with verbose output..."
          ssh -vvv -i ~/.ssh/deploy_key \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=10 \
              ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} \
              "echo 'SSH Connection successful!'" || echo "SSH connection failed"

      - name: Deploy to Raspberry Pi
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PI_HOST }}
          username: ${{ secrets.PI_USER }}
          key: ${{ secrets.PI_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 30m
          debug: true
          script: |
            set -e
            echo "ðŸš€ Starting deployment..."
            cd ~/alfa-hackathon
            git fetch origin
            git reset --hard origin/main
            docker compose -f docker-compose.yml -f docker-compose.prod.yml down || true
            docker image prune -f || true
            docker compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache
            docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
            sleep 15
            docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
            echo "âœ… Deployment completed!"
